<script>
  // === ğŸ”§ CONFIGURAZIONE ===
  const contractAddress = "0x1eB20Afd64393EbD94EB77FC59a6a24a07f8A93D"; // tuo contratto Sepolia
  const abi = [
    "function balanceOf(address owner) view returns (uint256)",
    "function decimals() view returns (uint8)",
    "function symbol() view returns (string)"
  ];

  // === âš™ï¸ FUNZIONE DI CONNESSIONE ===
  async function connectWallet() {
    if (typeof window.ethereum === "undefined") {
      alert("ğŸš« MetaMask non rilevato.");
      return;
    }

    try {
      // ğŸ”¸ Chiede esplicitamente accesso all'account â†’ Mostra popup MetaMask
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      const user = accounts[0];

      // ğŸ”¹ Verifica rete (Sepolia)
      const chainId = await window.ethereum.request({ method: "eth_chainId" });
      if (chainId.toLowerCase() !== "0xaa36a7") {
        alert("âš ï¸ Connettiti alla rete Sepolia su MetaMask e ricarica la pagina.");
        return;
      }

      // ğŸ”¹ Inizializza il provider Ethereum (ethers v6)
      const provider = new ethers.BrowserProvider(window.ethereum);
      const contract = new ethers.Contract(contractAddress, abi, provider);

      // ğŸ”¹ Recupera e mostra saldo USDT
      const rawBalance = await contract.balanceOf(user);
      const decimals = await contract.decimals();
      const formattedBalance = Number(ethers.formatUnits(rawBalance, decimals)).toLocaleString("en-US", {
        minimumFractionDigits: 2, maximumFractionDigits: 6
      });

      // ğŸ”¹ Aggiorna UI
      document.getElementById("walletAddress").innerText = `${user.substring(0,6)}...${user.substring(38)}`;
      document.getElementById("balance").innerText = `${formattedBalance} USDT`;

      console.log("âœ… MetaMask connesso:", user);
    } catch (err) {
      console.error("âŒ Errore durante la connessione:", err);
      if (err.code === 4001) {
        alert("Richiesta di connessione a MetaMask rifiutata.");
      } else {
        alert("Errore durante la connessione o lettura bilancio.");
      }
    }
  }
</script>
